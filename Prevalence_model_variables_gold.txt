//CREATE OR REPLACE TABLE CPRD_MODELLING_GOLD AS

with antipark_drugs as (SELECT *
FROM prod_conform.cprd.gold_antiparkinsontherapy_therapy_202403
),
patients as (select pat.patid,pat.yob,pat.gender,prac.region from prod_conform.cprd.gold_antiparkinsontherapy_patient_202403 pat
left join sandpit.pairuthayaraj.allantipark_gold_practice prac ON CAST(SUBSTRING(pat.patid, -5) AS INT) = prac.pracid
),
therapy_stats AS (
    SELECT 
        patid,
        MIN(TO_DATE(eventdate, 'DD/MM/YYYY')) AS firsttherapy,
        MAX(TO_DATE(eventdate, 'DD/MM/YYYY')) AS lasttherapy
    FROM antipark_drugs
    GROUP BY patid
),

firstdrug as(select patid,
   firsttherapy,
   DATEDIFF('MONTH', firsttherapy, lasttherapy) AS therapy_duration
FROM therapy_stats),

drugclass as (select ad.patid,ad.prodcode,dc.drugclass from antipark_drugs ad
left join SANDPIT.RGRAVESANDE.GOLD_CONVERSION_FACTOR dc on ad.prodcode=dc.prodcode),


drugclass_flags AS (
    SELECT
        patid,
        MAX(CASE WHEN drugclass = 'MAOB' THEN 1 ELSE 0 END) AS MAOB,
        MAX(CASE WHEN drugclass = 'COMT' THEN 1 ELSE 0 END) AS COMT,
        MAX(CASE WHEN drugclass = 'LD' THEN 1 ELSE 0 END) AS LD,
        MAX(CASE WHEN drugclass = 'DA' THEN 1 ELSE 0 END) AS DA,
        MAX(CASE WHEN drugclass = 'LD + COMT' THEN 1 ELSE 0 END) AS LDCOMT,
        MAX(CASE WHEN drugclass = 'Ama' THEN 1 ELSE 0 END) AS Ama,
        MAX(CASE WHEN drugclass = 'Other' THEN 1 ELSE 0 END) AS Other
    FROM
        drugclass
    GROUP BY
        patid
),
onlysymptoms as (
SELECT 
        a.patid,a.medcode, TRIM(b.category) as category
        
    FROM 
        prod_conform.cprd.gold_antiparkinsontherapy_clinical_202403 a
    INNER JOIN 
        sandpit.pairuthayaraj.symptom_groups_gold b
    ON 
        a.medcode = b.medcode
    WHERE 
        a.constype IN (1, 3)),
        
symptoms as (SELECT
    patid,
    MAX(CASE WHEN category = 'Insomnia' THEN 1 ELSE 0 END) AS Insomnia,
    MAX(CASE WHEN category = 'Fracture' THEN 1 ELSE 0 END) AS Fracture,
    MAX(CASE WHEN category = 'Cough' THEN 1 ELSE 0 END) AS Cough,
    MAX(CASE WHEN category = 'Actinic keratosis' THEN 1 ELSE 0 END) AS Actinic_keratosis,
    MAX(CASE WHEN category = 'Acute sinusitis' THEN 1 ELSE 0 END) AS Acute_sinusitis,
    MAX(CASE WHEN category = 'Carpal tunnel' THEN 1 ELSE 0 END) AS Carpal_tunnel,
    MAX(CASE WHEN category = 'Falls' THEN 1 ELSE 0 END) AS Falls,
    MAX(CASE WHEN category = 'Tremor' THEN 1 ELSE 0 END) AS Tremor,
    MAX(CASE WHEN category = 'Sore throat' THEN 1 ELSE 0 END) AS Sore_throat,
    MAX(CASE WHEN category = 'Depression' THEN 1 ELSE 0 END) AS Depression,
    MAX(CASE WHEN category = 'Pain' THEN 1 ELSE 0 END) AS Pain,
    MAX(CASE WHEN category = 'Breast lump' THEN 1 ELSE 0 END) AS Breast_lump
FROM onlysymptoms
GROUP BY patid),

ledd as (select distinct patid,"2023 LEDD" as ledd_2023,"2022 LEDD" as ledd_2022,"2021 LEDD" as ledd_2021,"2020 LEDD" as ledd_2020,"2019 LEDD" as ledd_2019,"2018 LEDD" as ledd_2018 from sandpit.rgravesande.all_antipark_ledd_calc_poc)


select fd.patid,fd.firsttherapy,
CASE
        WHEN pat.gender = 1 THEN 'Male'
        WHEN pat.gender = 2 THEN 'Female'
        WHEN pat.gender = 3 THEN 'Other'
 END AS gender,
CASE
        WHEN pat.region = 1 THEN 'North East'
        WHEN pat.region = 2 THEN 'North West'
        WHEN pat.region = 3 THEN 'Yorkshire and The Humber'
        WHEN pat.region = 4 THEN 'East Midlands'
        WHEN pat.region = 5 THEN 'West Midlands'
        WHEN pat.region = 6 THEN 'East of England'
        WHEN pat.region = 7 THEN 'London'
        WHEN pat.region = 8 THEN 'South East'
        WHEN pat.region = 9 THEN 'South West'
        WHEN pat.region = 10 THEN 'Wales'
        WHEN pat.region = 11 THEN 'Scotland'
        WHEN pat.region = 12 THEN 'Northern Ireland'
        ELSE 'Unknown'
 END AS region,
(2023 - CAST(pat.yob AS INTEGER)) AS age,fd.therapy_duration,
(EXTRACT(YEAR FROM fd.firsttherapy) - CAST(pat.yob AS INTEGER)) AS age_at_firsttherapy,dcf.MAOB,dcf.COMT,dcf.LD,dcf.DA,dcf.LDCOMT,dcf.Ama,dcf.Other,
COALESCE(symp.Insomnia, 0) AS Insomnia,
    COALESCE(symp.Fracture, 0) AS Fracture,
    COALESCE(symp.Cough, 0) AS Cough,
    COALESCE(symp.Actinic_keratosis, 0) AS Actinic_keratosis,
    COALESCE(symp.Acute_sinusitis, 0) AS Acute_sinusitis,
    COALESCE(symp.Carpal_tunnel, 0) AS Carpal_tunnel,
    COALESCE(symp.Falls, 0) AS Falls,
    COALESCE(symp.Tremor, 0) AS Tremor,
    COALESCE(symp.Sore_throat, 0) AS Sore_throat,
    COALESCE(symp.Depression, 0) AS Depression,
    COALESCE(symp.Pain, 0) AS Pain,
    COALESCE(symp.Breast_lump, 0) AS Breast_lump,
    COALESCE(ledd.ledd_2023, 0) AS ledd_2023,
    COALESCE(ledd.ledd_2022, 0) AS ledd_2022,
    COALESCE(ledd.ledd_2021, 0) AS ledd_2021,
    COALESCE(ledd.ledd_2020, 0) AS ledd_2020,
    COALESCE(ledd.ledd_2019, 0) AS ledd_2019,
    COALESCE(ledd.ledd_2018, 0) AS ledd_2018,
gb.smokingcategory,gb.bmi,'Gold' AS database,COALESCE(hd.category, mg.category) AS diagnosis_group
from firstdrug fd
left join patients pat on pat.patid=fd.patid
left join drugclass_flags dcf on dcf.patid=fd.patid
left join symptoms symp on symp.patid=fd.patid
left join sandpit.pairuthayaraj.gold_smoking_bmi gb on gb.patid=fd.patid
left join sandpit.pairuthayaraj.allantipark_modelgroups_gold mg on mg.patid=fd.patid
LEFT JOIN sandpit.pairuthayaraj.hes_diagnosis_gold_model hd ON hd.patid = fd.patid
left join ledd on ledd.patid=fd.patid

